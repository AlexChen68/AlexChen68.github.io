import{_ as o,C as e,o as r,c,k as s,a,H as p,Q as n}from"./chunks/framework.419948d5.js";const g=JSON.parse('{"title":"分布式事务中间件 Seata","description":"","frontmatter":{"title":"分布式事务中间件 Seata","date":"2023-06-13T00:00:00.000Z","order":5},"headers":[],"relativePath":"architecture/distributed/seata.md","filePath":"architecture/distributed/seata.md","lastUpdated":1699559446000}'),t={name:"architecture/distributed/seata.md"},E=n(`<h1 id="分布式事务中间件-seata" tabindex="-1">分布式事务中间件 Seata <a class="header-anchor" href="#分布式事务中间件-seata" aria-label="Permalink to &quot;分布式事务中间件 Seata&quot;">​</a></h1><h2 id="什么是分布式事务" tabindex="-1">什么是分布式事务？ <a class="header-anchor" href="#什么是分布式事务" aria-label="Permalink to &quot;什么是分布式事务？&quot;">​</a></h2><p>事务是一个程序执行单元，里面的所有操作要么全部执行成功，要么全部执行失败。在分布式系统中，这些操作可能是位于不同的服务中，那么如果也能保证这些操作要么全部执行成功要么全部执行失败呢？这便是分布式事务要解决的问题。</p><h2 id="seata-简介" tabindex="-1">Seata 简介 <a class="header-anchor" href="#seata-简介" aria-label="Permalink to &quot;Seata 简介&quot;">​</a></h2><p>Seata 是一款开源的分布式事务解决方案，致力于在微服务架构下提供高性能和简单易用的分布式事务服务。</p><p>Seata 为用户提供了 <code>AT</code>、<code>TCC</code>、<code>SAGA</code> 和 <code>XA</code> 四种事务模式，打造一站式的分布式解决方案。</p><ul><li><a href="https://seata.io/zh-cn/index.html" target="_blank" rel="noreferrer">Seata 官网链接</a></li></ul><h2 id="seata-入门" tabindex="-1">seata 入门 <a class="header-anchor" href="#seata-入门" aria-label="Permalink to &quot;seata 入门&quot;">​</a></h2><h3 id="启动-seata-server" tabindex="-1">启动 seata server <a class="header-anchor" href="#启动-seata-server" aria-label="Permalink to &quot;启动 seata server&quot;">​</a></h3><p>Server 端存储模式（store.mode）现有 file、db、redis 三种（后续将引入 raft,mongodb），file 模式无需改动，直接启动即可，下面专门讲下 db 和 redis 启动步骤。</p><div class="warning custom-block"><p class="custom-block-title">注：</p><ul><li>file 模式为单机模式，全局事务会话信息内存中读写并持久化本地文件 root.data，性能较高（默认）。</li><li>db 模式为高可用模式，全局事务会话信息通过 db 共享，相应性能差些。</li><li>redis 模式 Seata-Server 1.3 及以上版本支持，性能较高，存在事务信息丢失风险，请提前配置合适当前场景的 redis 持久化配置。</li></ul></div><div class="danger custom-block"><p class="custom-block-title">重要‼️</p><p><strong>本文主要介绍使用 Nacos 作为数据中心和配置中心启动 seata server，采用 db 模式启动的方式。</strong></p></div><h4 id="下载-seata-server" tabindex="-1">下载 seata-server <a class="header-anchor" href="#下载-seata-server" aria-label="Permalink to &quot;下载 seata-server&quot;">​</a></h4><p>从 <a href="https://github.com/seata/seata/releases" target="_blank" rel="noreferrer">seata-release</a> 下载需要的版本压缩包解压。</p><p>示例：</p><div class="language-bash vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#B392F0;">wget</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">https://github.com/seata/seata/releases/download/v1.4.2/seata-server-1.4.2.zip</span></span>
<span class="line"><span style="color:#B392F0;">unzip</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">seata-server-1.4.2.zip</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6F42C1;">wget</span><span style="color:#24292E;"> </span><span style="color:#032F62;">https://github.com/seata/seata/releases/download/v1.4.2/seata-server-1.4.2.zip</span></span>
<span class="line"><span style="color:#6F42C1;">unzip</span><span style="color:#24292E;"> </span><span style="color:#032F62;">seata-server-1.4.2.zip</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>解压后，目录结果为：</p><div class="language- vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8;">├──bin  # 脚本目录</span></span>
<span class="line"><span style="color:#e1e4e8;">├──conf # 配置目录</span></span>
<span class="line"><span style="color:#e1e4e8;">├──log  # 日志目录</span></span>
<span class="line"><span style="color:#e1e4e8;">└──lib  # jar包目录</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e;">├──bin  # 脚本目录</span></span>
<span class="line"><span style="color:#24292e;">├──conf # 配置目录</span></span>
<span class="line"><span style="color:#24292e;">├──log  # 日志目录</span></span>
<span class="line"><span style="color:#24292e;">└──lib  # jar包目录</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><h4 id="配置-registry-conf" tabindex="-1">配置 <code>registry.conf</code> <a class="header-anchor" href="#配置-registry-conf" aria-label="Permalink to &quot;配置 \`registry.conf\`&quot;">​</a></h4><p>Seata 服务端的 <code>conf</code> 目录可以看到配置文件：</p><ul><li><p><code>registry.conf</code>：该文件必须存在。定义 seata-server 所需要的：registry 注册中心和 config 配置中心。</p><ul><li><code>registry.type</code> 注册中心类型可选范围为：file、nacos、eureka、redis、zk、consul、etcd3、sofa。通常选择 nacos 配置中心作为注册中心。</li><li><code>config.type</code> 配置中心类型可选择范围为：file、nacos、apollo、zk、consul、etcd3。</li></ul></li><li><p><code>file.conf</code>：仅在服务端 registry.conf 文件中选择配置 registry.type=file 或 config.type=file 时，才需要此 file.conf 文件（可在此文件中指定分布式事务管理的存储模式 store.mode）</p></li><li><p>无论是 file、还是 nacos，还是其他作为配置来源。都需要定义分布式事务管理的存储模式 <code>store.mode</code>。存储模式有三种：<code>file</code>、<code>db</code>、<code>redis</code>。</p><ul><li>若选择为 store.mode=file，Seata 的事务相关信息会存储在内存中，并持久化到本地 root.data 文件中，性能比较高。</li><li>若选择为 store.mode=db。Seata 的事务相关信息会存储在数据库中。使用数据库模式可以支持多个 seata-server 启动，实现 seata-server 高可用。</li></ul></li></ul><p><code>registry.conf</code> 示例配置：</p><div class="language-conf vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">conf</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8;">registry {</span></span>
<span class="line"><span style="color:#e1e4e8;">  type = &quot;nacos&quot;</span></span>
<span class="line"><span style="color:#e1e4e8;"></span></span>
<span class="line"><span style="color:#e1e4e8;">  nacos {</span></span>
<span class="line"><span style="color:#e1e4e8;">    application = &quot;seata-server&quot;</span></span>
<span class="line"><span style="color:#e1e4e8;">    serverAddr = &quot;127.0.0.1:8848&quot;</span></span>
<span class="line"><span style="color:#e1e4e8;">    group = &quot;SEATA_GROUP&quot;</span></span>
<span class="line"><span style="color:#e1e4e8;">    namespace = &quot;public&quot;</span></span>
<span class="line"><span style="color:#e1e4e8;">    cluster = &quot;default&quot;</span></span>
<span class="line"><span style="color:#e1e4e8;">    username = &quot;nacos&quot;</span></span>
<span class="line"><span style="color:#e1e4e8;">    password = &quot;nacos&quot;</span></span>
<span class="line"><span style="color:#e1e4e8;">  }</span></span>
<span class="line"><span style="color:#e1e4e8;">}</span></span>
<span class="line"><span style="color:#e1e4e8;"></span></span>
<span class="line"><span style="color:#e1e4e8;">config {</span></span>
<span class="line"><span style="color:#e1e4e8;">  type = &quot;nacos&quot;</span></span>
<span class="line"><span style="color:#e1e4e8;"></span></span>
<span class="line"><span style="color:#e1e4e8;">  nacos {</span></span>
<span class="line"><span style="color:#e1e4e8;">    serverAddr = &quot;127.0.0.1:8848&quot;</span></span>
<span class="line"><span style="color:#e1e4e8;">    namespace = &quot;public&quot;</span></span>
<span class="line"><span style="color:#e1e4e8;">    group = &quot;SEATA_GROUP&quot;</span></span>
<span class="line"><span style="color:#e1e4e8;">    username = &quot;nacos&quot;</span></span>
<span class="line"><span style="color:#e1e4e8;">    password = &quot;nacos&quot;</span></span>
<span class="line"><span style="color:#e1e4e8;">    dataId = &quot;seata-server.properties&quot;</span></span>
<span class="line"><span style="color:#e1e4e8;">  }</span></span>
<span class="line"><span style="color:#e1e4e8;">}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e;">registry {</span></span>
<span class="line"><span style="color:#24292e;">  type = &quot;nacos&quot;</span></span>
<span class="line"><span style="color:#24292e;"></span></span>
<span class="line"><span style="color:#24292e;">  nacos {</span></span>
<span class="line"><span style="color:#24292e;">    application = &quot;seata-server&quot;</span></span>
<span class="line"><span style="color:#24292e;">    serverAddr = &quot;127.0.0.1:8848&quot;</span></span>
<span class="line"><span style="color:#24292e;">    group = &quot;SEATA_GROUP&quot;</span></span>
<span class="line"><span style="color:#24292e;">    namespace = &quot;public&quot;</span></span>
<span class="line"><span style="color:#24292e;">    cluster = &quot;default&quot;</span></span>
<span class="line"><span style="color:#24292e;">    username = &quot;nacos&quot;</span></span>
<span class="line"><span style="color:#24292e;">    password = &quot;nacos&quot;</span></span>
<span class="line"><span style="color:#24292e;">  }</span></span>
<span class="line"><span style="color:#24292e;">}</span></span>
<span class="line"><span style="color:#24292e;"></span></span>
<span class="line"><span style="color:#24292e;">config {</span></span>
<span class="line"><span style="color:#24292e;">  type = &quot;nacos&quot;</span></span>
<span class="line"><span style="color:#24292e;"></span></span>
<span class="line"><span style="color:#24292e;">  nacos {</span></span>
<span class="line"><span style="color:#24292e;">    serverAddr = &quot;127.0.0.1:8848&quot;</span></span>
<span class="line"><span style="color:#24292e;">    namespace = &quot;public&quot;</span></span>
<span class="line"><span style="color:#24292e;">    group = &quot;SEATA_GROUP&quot;</span></span>
<span class="line"><span style="color:#24292e;">    username = &quot;nacos&quot;</span></span>
<span class="line"><span style="color:#24292e;">    password = &quot;nacos&quot;</span></span>
<span class="line"><span style="color:#24292e;">    dataId = &quot;seata-server.properties&quot;</span></span>
<span class="line"><span style="color:#24292e;">  }</span></span>
<span class="line"><span style="color:#24292e;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br></div></div><div class="tip custom-block"><p class="custom-block-title">总结</p><p><code>registry.conf</code> 用来配置 seata-server 向哪里注册，配置存储在哪里；如果配置为 file，使用 conf/file.conf 配置；如果使用 nacos 作为配置中心，需要在 nacos 添加一个配置文件，将 seata-server 存储其中，并在 <code>registry.conf</code> 的 config 中配置 <code>dataId</code>。</p><p>如果 seata-server 的配置中设置 <code>store.mode=db</code>，需要填写对应的数据库信息，并初始化数据库表结构到数据库。</p></div>`,24),y={id:"初始化数据库表结构",tabindex:"-1"},i=s("a",{class:"header-anchor",href:"#初始化数据库表结构","aria-label":'Permalink to "初始化数据库表结构 <Badge text="仅 db 模式需要" type="tip"/>"'},"​",-1),d=n('<p>从 <a href="https://github.com/seata/seata/" target="_blank" rel="noreferrer">seata 源码</a> 的 <code>/script/server/db</code> 目录下，下载对应的数据库 sql，在数据库执行。</p><p>或使用下面的 sql 语句（<em>ps：可能会过期，最好还是获取对应版本的</em>）</p><div class="language-sql vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">sql</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#6A737D;">-- -------------------------------- The script used when storeMode is &#39;db&#39; --------------------------------</span></span>\n<span class="line"><span style="color:#6A737D;">-- the table to store GlobalSession data</span></span>\n<span class="line"><span style="color:#F97583;">CREATE</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">TABLE</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">IF</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">NOT</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">EXISTS</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">`global_table`</span></span>\n<span class="line"><span style="color:#E1E4E8;">(</span></span>\n<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#9ECBFF;">`xid`</span><span style="color:#E1E4E8;">                       </span><span style="color:#F97583;">VARCHAR</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">128</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">NOT NULL</span><span style="color:#E1E4E8;">,</span></span>\n<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#9ECBFF;">`transaction_id`</span><span style="color:#E1E4E8;">            </span><span style="color:#F97583;">BIGINT</span><span style="color:#E1E4E8;">,</span></span>\n<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#9ECBFF;">`status`</span><span style="color:#E1E4E8;">                    </span><span style="color:#F97583;">TINYINT</span><span style="color:#E1E4E8;">      </span><span style="color:#F97583;">NOT NULL</span><span style="color:#E1E4E8;">,</span></span>\n<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#9ECBFF;">`application_id`</span><span style="color:#E1E4E8;">            </span><span style="color:#F97583;">VARCHAR</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">32</span><span style="color:#E1E4E8;">),</span></span>\n<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#9ECBFF;">`transaction_service_group`</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">VARCHAR</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">32</span><span style="color:#E1E4E8;">),</span></span>\n<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#9ECBFF;">`transaction_name`</span><span style="color:#E1E4E8;">          </span><span style="color:#F97583;">VARCHAR</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">128</span><span style="color:#E1E4E8;">),</span></span>\n<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#9ECBFF;">`timeout`</span><span style="color:#E1E4E8;">                   </span><span style="color:#F97583;">INT</span><span style="color:#E1E4E8;">,</span></span>\n<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#9ECBFF;">`begin_time`</span><span style="color:#E1E4E8;">                </span><span style="color:#F97583;">BIGINT</span><span style="color:#E1E4E8;">,</span></span>\n<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#9ECBFF;">`application_data`</span><span style="color:#E1E4E8;">          </span><span style="color:#F97583;">VARCHAR</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">2000</span><span style="color:#E1E4E8;">),</span></span>\n<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#9ECBFF;">`gmt_create`</span><span style="color:#E1E4E8;">                </span><span style="color:#F97583;">DATETIME</span><span style="color:#E1E4E8;">,</span></span>\n<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#9ECBFF;">`gmt_modified`</span><span style="color:#E1E4E8;">              </span><span style="color:#F97583;">DATETIME</span><span style="color:#E1E4E8;">,</span></span>\n<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">PRIMARY KEY</span><span style="color:#E1E4E8;"> (</span><span style="color:#9ECBFF;">`xid`</span><span style="color:#E1E4E8;">),</span></span>\n<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">KEY</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">`idx_status_gmt_modified`</span><span style="color:#E1E4E8;"> (</span><span style="color:#9ECBFF;">`status`</span><span style="color:#E1E4E8;"> , </span><span style="color:#9ECBFF;">`gmt_modified`</span><span style="color:#E1E4E8;">),</span></span>\n<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">KEY</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">`idx_transaction_id`</span><span style="color:#E1E4E8;"> (</span><span style="color:#9ECBFF;">`transaction_id`</span><span style="color:#E1E4E8;">)</span></span>\n<span class="line"><span style="color:#E1E4E8;">) ENGINE </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> InnoDB</span></span>\n<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">DEFAULT</span><span style="color:#E1E4E8;"> CHARSET </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> utf8mb4;</span></span>\n<span class="line"></span>\n<span class="line"><span style="color:#6A737D;">-- the table to store BranchSession data</span></span>\n<span class="line"><span style="color:#F97583;">CREATE</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">TABLE</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">IF</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">NOT</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">EXISTS</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">`branch_table`</span></span>\n<span class="line"><span style="color:#E1E4E8;">(</span></span>\n<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#9ECBFF;">`branch_id`</span><span style="color:#E1E4E8;">         </span><span style="color:#F97583;">BIGINT</span><span style="color:#E1E4E8;">       </span><span style="color:#F97583;">NOT NULL</span><span style="color:#E1E4E8;">,</span></span>\n<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#9ECBFF;">`xid`</span><span style="color:#E1E4E8;">               </span><span style="color:#F97583;">VARCHAR</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">128</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">NOT NULL</span><span style="color:#E1E4E8;">,</span></span>\n<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#9ECBFF;">`transaction_id`</span><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">BIGINT</span><span style="color:#E1E4E8;">,</span></span>\n<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#9ECBFF;">`resource_group_id`</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">VARCHAR</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">32</span><span style="color:#E1E4E8;">),</span></span>\n<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#9ECBFF;">`resource_id`</span><span style="color:#E1E4E8;">       </span><span style="color:#F97583;">VARCHAR</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">256</span><span style="color:#E1E4E8;">),</span></span>\n<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#9ECBFF;">`branch_type`</span><span style="color:#E1E4E8;">       </span><span style="color:#F97583;">VARCHAR</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">8</span><span style="color:#E1E4E8;">),</span></span>\n<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#9ECBFF;">`status`</span><span style="color:#E1E4E8;">            </span><span style="color:#F97583;">TINYINT</span><span style="color:#E1E4E8;">,</span></span>\n<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#9ECBFF;">`client_id`</span><span style="color:#E1E4E8;">         </span><span style="color:#F97583;">VARCHAR</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">64</span><span style="color:#E1E4E8;">),</span></span>\n<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#9ECBFF;">`application_data`</span><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">VARCHAR</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">2000</span><span style="color:#E1E4E8;">),</span></span>\n<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#9ECBFF;">`gmt_create`</span><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">DATETIME</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">6</span><span style="color:#E1E4E8;">),</span></span>\n<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#9ECBFF;">`gmt_modified`</span><span style="color:#E1E4E8;">      </span><span style="color:#F97583;">DATETIME</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">6</span><span style="color:#E1E4E8;">),</span></span>\n<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">PRIMARY KEY</span><span style="color:#E1E4E8;"> (</span><span style="color:#9ECBFF;">`branch_id`</span><span style="color:#E1E4E8;">),</span></span>\n<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">KEY</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">`idx_xid`</span><span style="color:#E1E4E8;"> (</span><span style="color:#9ECBFF;">`xid`</span><span style="color:#E1E4E8;">)</span></span>\n<span class="line"><span style="color:#E1E4E8;">) ENGINE </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> InnoDB</span></span>\n<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">DEFAULT</span><span style="color:#E1E4E8;"> CHARSET </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> utf8mb4;</span></span>\n<span class="line"></span>\n<span class="line"><span style="color:#6A737D;">-- the table to store lock data</span></span>\n<span class="line"><span style="color:#F97583;">CREATE</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">TABLE</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">IF</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">NOT</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">EXISTS</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">`lock_table`</span></span>\n<span class="line"><span style="color:#E1E4E8;">(</span></span>\n<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#9ECBFF;">`row_key`</span><span style="color:#E1E4E8;">        </span><span style="color:#F97583;">VARCHAR</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">128</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">NOT NULL</span><span style="color:#E1E4E8;">,</span></span>\n<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#9ECBFF;">`xid`</span><span style="color:#E1E4E8;">            </span><span style="color:#F97583;">VARCHAR</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">128</span><span style="color:#E1E4E8;">),</span></span>\n<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#9ECBFF;">`transaction_id`</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">BIGINT</span><span style="color:#E1E4E8;">,</span></span>\n<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#9ECBFF;">`branch_id`</span><span style="color:#E1E4E8;">      </span><span style="color:#F97583;">BIGINT</span><span style="color:#E1E4E8;">       </span><span style="color:#F97583;">NOT NULL</span><span style="color:#E1E4E8;">,</span></span>\n<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#9ECBFF;">`resource_id`</span><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">VARCHAR</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">256</span><span style="color:#E1E4E8;">),</span></span>\n<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#9ECBFF;">`table_name`</span><span style="color:#E1E4E8;">     </span><span style="color:#F97583;">VARCHAR</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">32</span><span style="color:#E1E4E8;">),</span></span>\n<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#9ECBFF;">`pk`</span><span style="color:#E1E4E8;">             </span><span style="color:#F97583;">VARCHAR</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">36</span><span style="color:#E1E4E8;">),</span></span>\n<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#9ECBFF;">`status`</span><span style="color:#E1E4E8;">         </span><span style="color:#F97583;">TINYINT</span><span style="color:#E1E4E8;">      </span><span style="color:#F97583;">NOT NULL</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">DEFAULT</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&#39;0&#39;</span><span style="color:#E1E4E8;"> COMMENT </span><span style="color:#9ECBFF;">&#39;0:locked ,1:rollbacking&#39;</span><span style="color:#E1E4E8;">,</span></span>\n<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#9ECBFF;">`gmt_create`</span><span style="color:#E1E4E8;">     </span><span style="color:#F97583;">DATETIME</span><span style="color:#E1E4E8;">,</span></span>\n<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#9ECBFF;">`gmt_modified`</span><span style="color:#E1E4E8;">   </span><span style="color:#F97583;">DATETIME</span><span style="color:#E1E4E8;">,</span></span>\n<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">PRIMARY KEY</span><span style="color:#E1E4E8;"> (</span><span style="color:#9ECBFF;">`row_key`</span><span style="color:#E1E4E8;">),</span></span>\n<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">KEY</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">`idx_status`</span><span style="color:#E1E4E8;"> (</span><span style="color:#9ECBFF;">`status`</span><span style="color:#E1E4E8;">),</span></span>\n<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">KEY</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">`idx_branch_id`</span><span style="color:#E1E4E8;"> (</span><span style="color:#9ECBFF;">`branch_id`</span><span style="color:#E1E4E8;">),</span></span>\n<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">KEY</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">`idx_xid_and_branch_id`</span><span style="color:#E1E4E8;"> (</span><span style="color:#9ECBFF;">`xid`</span><span style="color:#E1E4E8;"> , </span><span style="color:#9ECBFF;">`branch_id`</span><span style="color:#E1E4E8;">)</span></span>\n<span class="line"><span style="color:#E1E4E8;">) ENGINE </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> InnoDB</span></span>\n<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">DEFAULT</span><span style="color:#E1E4E8;"> CHARSET </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> utf8mb4;</span></span>\n<span class="line"></span>\n<span class="line"><span style="color:#F97583;">CREATE</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">TABLE</span><span style="color:#E1E4E8;"> </span><span style="color:#B392F0;">IF</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">NOT</span><span style="color:#E1E4E8;"> </span><span style="color:#F97583;">EXISTS</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">`distributed_lock`</span></span>\n<span class="line"><span style="color:#E1E4E8;">(</span></span>\n<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#9ECBFF;">`lock_key`</span><span style="color:#E1E4E8;">       </span><span style="color:#F97583;">CHAR</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">20</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">NOT NULL</span><span style="color:#E1E4E8;">,</span></span>\n<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#9ECBFF;">`lock_value`</span><span style="color:#E1E4E8;">     </span><span style="color:#F97583;">VARCHAR</span><span style="color:#E1E4E8;">(</span><span style="color:#79B8FF;">20</span><span style="color:#E1E4E8;">) </span><span style="color:#F97583;">NOT NULL</span><span style="color:#E1E4E8;">,</span></span>\n<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#9ECBFF;">`expire`</span><span style="color:#E1E4E8;">         </span><span style="color:#F97583;">BIGINT</span><span style="color:#E1E4E8;">,</span></span>\n<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#F97583;">primary key</span><span style="color:#E1E4E8;"> (</span><span style="color:#9ECBFF;">`lock_key`</span><span style="color:#E1E4E8;">)</span></span>\n<span class="line"><span style="color:#E1E4E8;">) ENGINE </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> InnoDB</span></span>\n<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">DEFAULT</span><span style="color:#E1E4E8;"> CHARSET </span><span style="color:#F97583;">=</span><span style="color:#E1E4E8;"> utf8mb4;</span></span>\n<span class="line"></span>\n<span class="line"><span style="color:#F97583;">INSERT INTO</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">`distributed_lock`</span><span style="color:#E1E4E8;"> (lock_key, lock_value, expire) </span><span style="color:#F97583;">VALUES</span><span style="color:#E1E4E8;"> (</span><span style="color:#9ECBFF;">&#39;AsyncCommitting&#39;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&#39; &#39;</span><span style="color:#E1E4E8;">, </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">);</span></span>\n<span class="line"><span style="color:#F97583;">INSERT INTO</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">`distributed_lock`</span><span style="color:#E1E4E8;"> (lock_key, lock_value, expire) </span><span style="color:#F97583;">VALUES</span><span style="color:#E1E4E8;"> (</span><span style="color:#9ECBFF;">&#39;RetryCommitting&#39;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&#39; &#39;</span><span style="color:#E1E4E8;">, </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">);</span></span>\n<span class="line"><span style="color:#F97583;">INSERT INTO</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">`distributed_lock`</span><span style="color:#E1E4E8;"> (lock_key, lock_value, expire) </span><span style="color:#F97583;">VALUES</span><span style="color:#E1E4E8;"> (</span><span style="color:#9ECBFF;">&#39;RetryRollbacking&#39;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&#39; &#39;</span><span style="color:#E1E4E8;">, </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">);</span></span>\n<span class="line"><span style="color:#F97583;">INSERT INTO</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">`distributed_lock`</span><span style="color:#E1E4E8;"> (lock_key, lock_value, expire) </span><span style="color:#F97583;">VALUES</span><span style="color:#E1E4E8;"> (</span><span style="color:#9ECBFF;">&#39;TxTimeoutCheck&#39;</span><span style="color:#E1E4E8;">, </span><span style="color:#9ECBFF;">&#39; &#39;</span><span style="color:#E1E4E8;">, </span><span style="color:#79B8FF;">0</span><span style="color:#E1E4E8;">);</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6A737D;">-- -------------------------------- The script used when storeMode is &#39;db&#39; --------------------------------</span></span>\n<span class="line"><span style="color:#6A737D;">-- the table to store GlobalSession data</span></span>\n<span class="line"><span style="color:#D73A49;">CREATE</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">TABLE</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">IF</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">NOT</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">EXISTS</span><span style="color:#24292E;"> </span><span style="color:#032F62;">`global_table`</span></span>\n<span class="line"><span style="color:#24292E;">(</span></span>\n<span class="line"><span style="color:#24292E;">    </span><span style="color:#032F62;">`xid`</span><span style="color:#24292E;">                       </span><span style="color:#D73A49;">VARCHAR</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">128</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">NOT NULL</span><span style="color:#24292E;">,</span></span>\n<span class="line"><span style="color:#24292E;">    </span><span style="color:#032F62;">`transaction_id`</span><span style="color:#24292E;">            </span><span style="color:#D73A49;">BIGINT</span><span style="color:#24292E;">,</span></span>\n<span class="line"><span style="color:#24292E;">    </span><span style="color:#032F62;">`status`</span><span style="color:#24292E;">                    </span><span style="color:#D73A49;">TINYINT</span><span style="color:#24292E;">      </span><span style="color:#D73A49;">NOT NULL</span><span style="color:#24292E;">,</span></span>\n<span class="line"><span style="color:#24292E;">    </span><span style="color:#032F62;">`application_id`</span><span style="color:#24292E;">            </span><span style="color:#D73A49;">VARCHAR</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">32</span><span style="color:#24292E;">),</span></span>\n<span class="line"><span style="color:#24292E;">    </span><span style="color:#032F62;">`transaction_service_group`</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">VARCHAR</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">32</span><span style="color:#24292E;">),</span></span>\n<span class="line"><span style="color:#24292E;">    </span><span style="color:#032F62;">`transaction_name`</span><span style="color:#24292E;">          </span><span style="color:#D73A49;">VARCHAR</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">128</span><span style="color:#24292E;">),</span></span>\n<span class="line"><span style="color:#24292E;">    </span><span style="color:#032F62;">`timeout`</span><span style="color:#24292E;">                   </span><span style="color:#D73A49;">INT</span><span style="color:#24292E;">,</span></span>\n<span class="line"><span style="color:#24292E;">    </span><span style="color:#032F62;">`begin_time`</span><span style="color:#24292E;">                </span><span style="color:#D73A49;">BIGINT</span><span style="color:#24292E;">,</span></span>\n<span class="line"><span style="color:#24292E;">    </span><span style="color:#032F62;">`application_data`</span><span style="color:#24292E;">          </span><span style="color:#D73A49;">VARCHAR</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">2000</span><span style="color:#24292E;">),</span></span>\n<span class="line"><span style="color:#24292E;">    </span><span style="color:#032F62;">`gmt_create`</span><span style="color:#24292E;">                </span><span style="color:#D73A49;">DATETIME</span><span style="color:#24292E;">,</span></span>\n<span class="line"><span style="color:#24292E;">    </span><span style="color:#032F62;">`gmt_modified`</span><span style="color:#24292E;">              </span><span style="color:#D73A49;">DATETIME</span><span style="color:#24292E;">,</span></span>\n<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">PRIMARY KEY</span><span style="color:#24292E;"> (</span><span style="color:#032F62;">`xid`</span><span style="color:#24292E;">),</span></span>\n<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">KEY</span><span style="color:#24292E;"> </span><span style="color:#032F62;">`idx_status_gmt_modified`</span><span style="color:#24292E;"> (</span><span style="color:#032F62;">`status`</span><span style="color:#24292E;"> , </span><span style="color:#032F62;">`gmt_modified`</span><span style="color:#24292E;">),</span></span>\n<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">KEY</span><span style="color:#24292E;"> </span><span style="color:#032F62;">`idx_transaction_id`</span><span style="color:#24292E;"> (</span><span style="color:#032F62;">`transaction_id`</span><span style="color:#24292E;">)</span></span>\n<span class="line"><span style="color:#24292E;">) ENGINE </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> InnoDB</span></span>\n<span class="line"><span style="color:#24292E;">  </span><span style="color:#D73A49;">DEFAULT</span><span style="color:#24292E;"> CHARSET </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> utf8mb4;</span></span>\n<span class="line"></span>\n<span class="line"><span style="color:#6A737D;">-- the table to store BranchSession data</span></span>\n<span class="line"><span style="color:#D73A49;">CREATE</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">TABLE</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">IF</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">NOT</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">EXISTS</span><span style="color:#24292E;"> </span><span style="color:#032F62;">`branch_table`</span></span>\n<span class="line"><span style="color:#24292E;">(</span></span>\n<span class="line"><span style="color:#24292E;">    </span><span style="color:#032F62;">`branch_id`</span><span style="color:#24292E;">         </span><span style="color:#D73A49;">BIGINT</span><span style="color:#24292E;">       </span><span style="color:#D73A49;">NOT NULL</span><span style="color:#24292E;">,</span></span>\n<span class="line"><span style="color:#24292E;">    </span><span style="color:#032F62;">`xid`</span><span style="color:#24292E;">               </span><span style="color:#D73A49;">VARCHAR</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">128</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">NOT NULL</span><span style="color:#24292E;">,</span></span>\n<span class="line"><span style="color:#24292E;">    </span><span style="color:#032F62;">`transaction_id`</span><span style="color:#24292E;">    </span><span style="color:#D73A49;">BIGINT</span><span style="color:#24292E;">,</span></span>\n<span class="line"><span style="color:#24292E;">    </span><span style="color:#032F62;">`resource_group_id`</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">VARCHAR</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">32</span><span style="color:#24292E;">),</span></span>\n<span class="line"><span style="color:#24292E;">    </span><span style="color:#032F62;">`resource_id`</span><span style="color:#24292E;">       </span><span style="color:#D73A49;">VARCHAR</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">256</span><span style="color:#24292E;">),</span></span>\n<span class="line"><span style="color:#24292E;">    </span><span style="color:#032F62;">`branch_type`</span><span style="color:#24292E;">       </span><span style="color:#D73A49;">VARCHAR</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">8</span><span style="color:#24292E;">),</span></span>\n<span class="line"><span style="color:#24292E;">    </span><span style="color:#032F62;">`status`</span><span style="color:#24292E;">            </span><span style="color:#D73A49;">TINYINT</span><span style="color:#24292E;">,</span></span>\n<span class="line"><span style="color:#24292E;">    </span><span style="color:#032F62;">`client_id`</span><span style="color:#24292E;">         </span><span style="color:#D73A49;">VARCHAR</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">64</span><span style="color:#24292E;">),</span></span>\n<span class="line"><span style="color:#24292E;">    </span><span style="color:#032F62;">`application_data`</span><span style="color:#24292E;">  </span><span style="color:#D73A49;">VARCHAR</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">2000</span><span style="color:#24292E;">),</span></span>\n<span class="line"><span style="color:#24292E;">    </span><span style="color:#032F62;">`gmt_create`</span><span style="color:#24292E;">        </span><span style="color:#D73A49;">DATETIME</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">6</span><span style="color:#24292E;">),</span></span>\n<span class="line"><span style="color:#24292E;">    </span><span style="color:#032F62;">`gmt_modified`</span><span style="color:#24292E;">      </span><span style="color:#D73A49;">DATETIME</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">6</span><span style="color:#24292E;">),</span></span>\n<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">PRIMARY KEY</span><span style="color:#24292E;"> (</span><span style="color:#032F62;">`branch_id`</span><span style="color:#24292E;">),</span></span>\n<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">KEY</span><span style="color:#24292E;"> </span><span style="color:#032F62;">`idx_xid`</span><span style="color:#24292E;"> (</span><span style="color:#032F62;">`xid`</span><span style="color:#24292E;">)</span></span>\n<span class="line"><span style="color:#24292E;">) ENGINE </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> InnoDB</span></span>\n<span class="line"><span style="color:#24292E;">  </span><span style="color:#D73A49;">DEFAULT</span><span style="color:#24292E;"> CHARSET </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> utf8mb4;</span></span>\n<span class="line"></span>\n<span class="line"><span style="color:#6A737D;">-- the table to store lock data</span></span>\n<span class="line"><span style="color:#D73A49;">CREATE</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">TABLE</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">IF</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">NOT</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">EXISTS</span><span style="color:#24292E;"> </span><span style="color:#032F62;">`lock_table`</span></span>\n<span class="line"><span style="color:#24292E;">(</span></span>\n<span class="line"><span style="color:#24292E;">    </span><span style="color:#032F62;">`row_key`</span><span style="color:#24292E;">        </span><span style="color:#D73A49;">VARCHAR</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">128</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">NOT NULL</span><span style="color:#24292E;">,</span></span>\n<span class="line"><span style="color:#24292E;">    </span><span style="color:#032F62;">`xid`</span><span style="color:#24292E;">            </span><span style="color:#D73A49;">VARCHAR</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">128</span><span style="color:#24292E;">),</span></span>\n<span class="line"><span style="color:#24292E;">    </span><span style="color:#032F62;">`transaction_id`</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">BIGINT</span><span style="color:#24292E;">,</span></span>\n<span class="line"><span style="color:#24292E;">    </span><span style="color:#032F62;">`branch_id`</span><span style="color:#24292E;">      </span><span style="color:#D73A49;">BIGINT</span><span style="color:#24292E;">       </span><span style="color:#D73A49;">NOT NULL</span><span style="color:#24292E;">,</span></span>\n<span class="line"><span style="color:#24292E;">    </span><span style="color:#032F62;">`resource_id`</span><span style="color:#24292E;">    </span><span style="color:#D73A49;">VARCHAR</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">256</span><span style="color:#24292E;">),</span></span>\n<span class="line"><span style="color:#24292E;">    </span><span style="color:#032F62;">`table_name`</span><span style="color:#24292E;">     </span><span style="color:#D73A49;">VARCHAR</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">32</span><span style="color:#24292E;">),</span></span>\n<span class="line"><span style="color:#24292E;">    </span><span style="color:#032F62;">`pk`</span><span style="color:#24292E;">             </span><span style="color:#D73A49;">VARCHAR</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">36</span><span style="color:#24292E;">),</span></span>\n<span class="line"><span style="color:#24292E;">    </span><span style="color:#032F62;">`status`</span><span style="color:#24292E;">         </span><span style="color:#D73A49;">TINYINT</span><span style="color:#24292E;">      </span><span style="color:#D73A49;">NOT NULL</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">DEFAULT</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&#39;0&#39;</span><span style="color:#24292E;"> COMMENT </span><span style="color:#032F62;">&#39;0:locked ,1:rollbacking&#39;</span><span style="color:#24292E;">,</span></span>\n<span class="line"><span style="color:#24292E;">    </span><span style="color:#032F62;">`gmt_create`</span><span style="color:#24292E;">     </span><span style="color:#D73A49;">DATETIME</span><span style="color:#24292E;">,</span></span>\n<span class="line"><span style="color:#24292E;">    </span><span style="color:#032F62;">`gmt_modified`</span><span style="color:#24292E;">   </span><span style="color:#D73A49;">DATETIME</span><span style="color:#24292E;">,</span></span>\n<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">PRIMARY KEY</span><span style="color:#24292E;"> (</span><span style="color:#032F62;">`row_key`</span><span style="color:#24292E;">),</span></span>\n<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">KEY</span><span style="color:#24292E;"> </span><span style="color:#032F62;">`idx_status`</span><span style="color:#24292E;"> (</span><span style="color:#032F62;">`status`</span><span style="color:#24292E;">),</span></span>\n<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">KEY</span><span style="color:#24292E;"> </span><span style="color:#032F62;">`idx_branch_id`</span><span style="color:#24292E;"> (</span><span style="color:#032F62;">`branch_id`</span><span style="color:#24292E;">),</span></span>\n<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">KEY</span><span style="color:#24292E;"> </span><span style="color:#032F62;">`idx_xid_and_branch_id`</span><span style="color:#24292E;"> (</span><span style="color:#032F62;">`xid`</span><span style="color:#24292E;"> , </span><span style="color:#032F62;">`branch_id`</span><span style="color:#24292E;">)</span></span>\n<span class="line"><span style="color:#24292E;">) ENGINE </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> InnoDB</span></span>\n<span class="line"><span style="color:#24292E;">  </span><span style="color:#D73A49;">DEFAULT</span><span style="color:#24292E;"> CHARSET </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> utf8mb4;</span></span>\n<span class="line"></span>\n<span class="line"><span style="color:#D73A49;">CREATE</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">TABLE</span><span style="color:#24292E;"> </span><span style="color:#6F42C1;">IF</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">NOT</span><span style="color:#24292E;"> </span><span style="color:#D73A49;">EXISTS</span><span style="color:#24292E;"> </span><span style="color:#032F62;">`distributed_lock`</span></span>\n<span class="line"><span style="color:#24292E;">(</span></span>\n<span class="line"><span style="color:#24292E;">    </span><span style="color:#032F62;">`lock_key`</span><span style="color:#24292E;">       </span><span style="color:#D73A49;">CHAR</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">20</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">NOT NULL</span><span style="color:#24292E;">,</span></span>\n<span class="line"><span style="color:#24292E;">    </span><span style="color:#032F62;">`lock_value`</span><span style="color:#24292E;">     </span><span style="color:#D73A49;">VARCHAR</span><span style="color:#24292E;">(</span><span style="color:#005CC5;">20</span><span style="color:#24292E;">) </span><span style="color:#D73A49;">NOT NULL</span><span style="color:#24292E;">,</span></span>\n<span class="line"><span style="color:#24292E;">    </span><span style="color:#032F62;">`expire`</span><span style="color:#24292E;">         </span><span style="color:#D73A49;">BIGINT</span><span style="color:#24292E;">,</span></span>\n<span class="line"><span style="color:#24292E;">    </span><span style="color:#D73A49;">primary key</span><span style="color:#24292E;"> (</span><span style="color:#032F62;">`lock_key`</span><span style="color:#24292E;">)</span></span>\n<span class="line"><span style="color:#24292E;">) ENGINE </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> InnoDB</span></span>\n<span class="line"><span style="color:#24292E;">  </span><span style="color:#D73A49;">DEFAULT</span><span style="color:#24292E;"> CHARSET </span><span style="color:#D73A49;">=</span><span style="color:#24292E;"> utf8mb4;</span></span>\n<span class="line"></span>\n<span class="line"><span style="color:#D73A49;">INSERT INTO</span><span style="color:#24292E;"> </span><span style="color:#032F62;">`distributed_lock`</span><span style="color:#24292E;"> (lock_key, lock_value, expire) </span><span style="color:#D73A49;">VALUES</span><span style="color:#24292E;"> (</span><span style="color:#032F62;">&#39;AsyncCommitting&#39;</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&#39; &#39;</span><span style="color:#24292E;">, </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">);</span></span>\n<span class="line"><span style="color:#D73A49;">INSERT INTO</span><span style="color:#24292E;"> </span><span style="color:#032F62;">`distributed_lock`</span><span style="color:#24292E;"> (lock_key, lock_value, expire) </span><span style="color:#D73A49;">VALUES</span><span style="color:#24292E;"> (</span><span style="color:#032F62;">&#39;RetryCommitting&#39;</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&#39; &#39;</span><span style="color:#24292E;">, </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">);</span></span>\n<span class="line"><span style="color:#D73A49;">INSERT INTO</span><span style="color:#24292E;"> </span><span style="color:#032F62;">`distributed_lock`</span><span style="color:#24292E;"> (lock_key, lock_value, expire) </span><span style="color:#D73A49;">VALUES</span><span style="color:#24292E;"> (</span><span style="color:#032F62;">&#39;RetryRollbacking&#39;</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&#39; &#39;</span><span style="color:#24292E;">, </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">);</span></span>\n<span class="line"><span style="color:#D73A49;">INSERT INTO</span><span style="color:#24292E;"> </span><span style="color:#032F62;">`distributed_lock`</span><span style="color:#24292E;"> (lock_key, lock_value, expire) </span><span style="color:#D73A49;">VALUES</span><span style="color:#24292E;"> (</span><span style="color:#032F62;">&#39;TxTimeoutCheck&#39;</span><span style="color:#24292E;">, </span><span style="color:#032F62;">&#39; &#39;</span><span style="color:#24292E;">, </span><span style="color:#005CC5;">0</span><span style="color:#24292E;">);</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br></div></div>',3),b={id:"nacos-配置-seata-server-properties",tabindex:"-1"},F=s("code",null,"seata-server.properties",-1),u=s("a",{class:"header-anchor",href:"#nacos-配置-seata-server-properties","aria-label":'Permalink to "Nacos 配置 `seata-server.properties`<Badge text="仅使用 Nacos 配置中心时配置" type="tip"/>"'},"​",-1),m=n(`<p>Nacos 新增配置文件 <code>seata-server.properties</code>，seata 的配置参数可以参考 <a href="http://seata.io/zh-cn/docs/user/configurations" target="_blank" rel="noreferrer">官方文档-seata 参数配置</a>，也可以从 seata 源码目录下 <code>/script/config-center/config.txt</code> 文件中选取需要的配置（config.txt 包含了 server 和 client 的配置）。</p><p><code>seata-server.properties</code> 示例配置：</p><div class="language-properties vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">properties</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#F97583;">service.vgroupMapping.zeus_tx_group</span><span style="color:#E1E4E8;">=default</span></span>
<span class="line"><span style="color:#F97583;">store.mode</span><span style="color:#E1E4E8;">=db</span></span>
<span class="line"><span style="color:#F97583;">store.db.datasource</span><span style="color:#E1E4E8;">=druid</span></span>
<span class="line"><span style="color:#F97583;">store.db.dbType</span><span style="color:#E1E4E8;">=mysql</span></span>
<span class="line"><span style="color:#F97583;">store.db.driverClassName</span><span style="color:#E1E4E8;">=com.mysql.cj.jdbc.Driver</span></span>
<span class="line"><span style="color:#F97583;">store.db.url</span><span style="color:#E1E4E8;">=jdbc:mysql://zeus-mysql:3306/seata_server?</span><span style="color:#F97583;">useUnicode</span><span style="color:#E1E4E8;">=true</span></span>
<span class="line"><span style="color:#F97583;">store.db.user</span><span style="color:#E1E4E8;">=\${MYSQL_USER:root}</span></span>
<span class="line"><span style="color:#F97583;">store.db.password</span><span style="color:#E1E4E8;">=\${MYSQL_PWD:123456}</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#D73A49;">service.vgroupMapping.zeus_tx_group</span><span style="color:#24292E;">=default</span></span>
<span class="line"><span style="color:#D73A49;">store.mode</span><span style="color:#24292E;">=db</span></span>
<span class="line"><span style="color:#D73A49;">store.db.datasource</span><span style="color:#24292E;">=druid</span></span>
<span class="line"><span style="color:#D73A49;">store.db.dbType</span><span style="color:#24292E;">=mysql</span></span>
<span class="line"><span style="color:#D73A49;">store.db.driverClassName</span><span style="color:#24292E;">=com.mysql.cj.jdbc.Driver</span></span>
<span class="line"><span style="color:#D73A49;">store.db.url</span><span style="color:#24292E;">=jdbc:mysql://zeus-mysql:3306/seata_server?</span><span style="color:#D73A49;">useUnicode</span><span style="color:#24292E;">=true</span></span>
<span class="line"><span style="color:#D73A49;">store.db.user</span><span style="color:#24292E;">=\${MYSQL_USER:root}</span></span>
<span class="line"><span style="color:#D73A49;">store.db.password</span><span style="color:#24292E;">=\${MYSQL_PWD:123456}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><h4 id="启动-server" tabindex="-1">启动 Server <a class="header-anchor" href="#启动-server" aria-label="Permalink to &quot;启动 Server&quot;">​</a></h4><p>首先进入 server 目录下的 <code>bin</code> 目录，然后调用 <code>seata-server.sh</code> 启动 server：</p><div class="language-bash vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#B392F0;">./seata-server.sh</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-h</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">127.0</span><span style="color:#9ECBFF;">.0.1</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-p</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">8091</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6F42C1;">./seata-server.sh</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-h</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">127.0</span><span style="color:#032F62;">.0.1</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-p</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">8091</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br></div></div><p>各启动参数含义：</p><div class="language-text vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">text</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8;">-h: 注册到注册中心的 ip</span></span>
<span class="line"><span style="color:#e1e4e8;">-p: Server rpc 监听端口</span></span>
<span class="line"><span style="color:#e1e4e8;">-m: 全局事务会话信息存储模式，file、db、redis，**优先读取启动参数** (Seata-Server 1.3 及以上版本支持 redis)</span></span>
<span class="line"><span style="color:#e1e4e8;">-n: Server node，当有多个 Server 时，需区分各自节点，用于生成不同区间的 transactionId，以免冲突</span></span>
<span class="line"><span style="color:#e1e4e8;">-e: 多环境配置参考 http://seata.io/en-us/docs/ops/multi-configuration-isolation.html</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e;">-h: 注册到注册中心的 ip</span></span>
<span class="line"><span style="color:#24292e;">-p: Server rpc 监听端口</span></span>
<span class="line"><span style="color:#24292e;">-m: 全局事务会话信息存储模式，file、db、redis，**优先读取启动参数** (Seata-Server 1.3 及以上版本支持 redis)</span></span>
<span class="line"><span style="color:#24292e;">-n: Server node，当有多个 Server 时，需区分各自节点，用于生成不同区间的 transactionId，以免冲突</span></span>
<span class="line"><span style="color:#24292e;">-e: 多环境配置参考 http://seata.io/en-us/docs/ops/multi-configuration-isolation.html</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><h3 id="集成-seata-client" tabindex="-1">集成 seata client <a class="header-anchor" href="#集成-seata-client" aria-label="Permalink to &quot;集成 seata client&quot;">​</a></h3>`,9);function A(C,_,h,T,B,D){const l=e("Badge");return r(),c("div",null,[E,s("h4",y,[a("初始化数据库表结构 "),p(l,{text:"仅 db 模式需要",type:"tip"}),a(),i]),d,s("h4",b,[a("Nacos 配置 "),F,p(l,{text:"仅使用 Nacos 配置中心时配置",type:"tip"}),a(),u]),m])}const N=o(t,[["render",A]]);export{g as __pageData,N as default};
